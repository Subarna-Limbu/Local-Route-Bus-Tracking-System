{% extends 'base.html' %}
{% block content %}
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #mainContent {
            height: calc(100vh - 120px); /* Adjust 120px if your header/footer are taller/shorter */
            min-height: 400px;
            width: 100vw;
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 100%;
            min-height: 400px;
        }
    </style>
    <h2 class="text-xl font-semibold mb-4">Live Bus Tracking</h2>
    <div id="mainContent">
        <div id="map"></div>
    </div>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const busId = "{{ bus_id }}";
        const socket = new WebSocket('ws://' + window.location.host + '/ws/location/' + busId + '/');
        let map = L.map('map').setView([27.7172, 85.3240], 13); // Default to Kathmandu
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);
        let marker = null;
        let locationReceived = false;
        socket.onmessage = function(event){
            const data = JSON.parse(event.data);
            console.log("Received location:", data);
            if (data.lat && data.lng) {
                locationReceived = true;
                if (!marker) {
                    marker = L.marker([data.lat, data.lng]).addTo(map);
                } else {
                    marker.setLatLng([data.lat, data.lng]);
                }
                map.setView([data.lat, data.lng], 15);
                document.getElementById('locationStatus').innerText = "Bus location updated.";
            }
        };
        // Show a message if no location data is received after 10 seconds
        setTimeout(function(){
            if (!locationReceived) {
                document.getElementById('locationStatus').innerText = "No live location received. The bus may not be online or tracking is not started.";
                // Optionally, show a fallback marker at the default location
                if (!marker) {
                    marker = L.marker([27.7172, 85.3240]).addTo(map);
                }
            }
        }, 10000);
    </script>
    <div id="locationStatus" class="mt-2 text-red-500 font-semibold"></div>
{% endblock %}
